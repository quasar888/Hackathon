<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resilience Orchestrator - Tableau de bord</title>
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .service-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
            border-left: 5px solid #ccc;
        }
        .service-card:hover {
            transform: translateY(-5px);
        }
        .service-card.healthy {
            border-left-color: #4CAF50;
        }
        .service-card.degraded {
            border-left-color: #FF9800;
        }
        .service-card.unhealthy {
            border-left-color: #f44336;
        }
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .service-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        .service-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }
        .status-healthy { background: #4CAF50; }
        .status-degraded { background: #FF9800; }
        .status-unhealthy { background: #f44336; }
        .service-details {
            color: #666;
            margin-top: 10px;
        }
        .service-details i {
            width: 20px;
            margin-right: 5px;
            color: #764ba2;
        }
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .chart-card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .alerts-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .alerts-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f5f5f5;
            color: #333;
        }
        tr:hover {
            background: #f9f9f9;
        }
        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .badge-high { background: #f44336; color: white; }
        .badge-medium { background: #FF9800; color: white; }
        .badge-low { background: #4CAF50; color: white; }
        .refresh-time {
            text-align: right;
            color: white;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .resource-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            text-align: center;
        }
        .stat-item {
            flex: 1;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #764ba2;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <i class="fas fa-project-diagram"></i>
            Resilience Orchestrator - Command Center
        </h1>

        <!-- État des services -->
        <div class="services-grid" id="servicesGrid"></div>

        <!-- Graphiques -->
        <div class="charts-row">
            <div class="chart-card">
                <h3><i class="fas fa-chart-pie"></i> Répartition des ressources par type</h3>
                <canvas id="resourcesChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-card">
                <h3><i class="fas fa-chart-line"></i> Performance historique (temps de réponse)</h3>
                <canvas id="performanceChart" width="400" height="300"></canvas>
            </div>
        </div>

        <!-- Alertes récentes -->
        <div class="alerts-section">
            <h3><i class="fas fa-exclamation-triangle"></i> Alertes récentes</h3>
            <table id="alertsTable">
                <thead>
                    <tr>
                        <th>Heure</th>
                        <th>Zone</th>
                        <th>Sévérité</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4">Chargement...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="refresh-time">
            Dernière mise à jour : <span id="lastRefresh">jamais</span>
            <i class="fas fa-sync-alt" style="margin-left: 10px; cursor: pointer;" onclick="refreshAll()"></i>
        </div>
    </div>

    <script>
        const basePort = '5000';
        const services = [
            { name: 'Orchestrator', port: basePort },
            { name: 'ResourceAgent', port: Number(basePort)+1 },
            { name: 'VolunteerAgent', port: Number(basePort)+2 },
            { name: 'AlertAgent', port: Number(basePort)+3 },
            { name: 'CommunicationAgent', port: Number(basePort)+4 },
            { name: 'PredictionService', port: Number(basePort)+5 }
        ];

        let resourcesChart, performanceChart;

        async function checkHealth() {
            const grid = document.getElementById('servicesGrid');
            grid.innerHTML = '';
            for (const svc of services) {
                try {
                    const res = await fetch(`http://localhost:${svc.port}/health`, { timeout: 2000 });
                    const healthy = res.ok;
                    const statusClass = healthy ? 'healthy' : 'unhealthy';
                    const statusText = healthy ? 'OK' : 'HS';
                    const statusBadge = healthy ? 'status-healthy' : 'status-unhealthy';
                    grid.innerHTML += `
                        <div class="service-card ${statusClass}">
                            <div class="service-header">
                                <span class="service-name">${svc.name}</span>
                                <span class="service-status ${statusBadge}">${statusText}</span>
                            </div>
                            <div class="service-details">
                                <i class="fas fa-plug"></i> Port: ${svc.port}<br>
                                <i class="fas fa-clock"></i> Uptime: ~
                            </div>
                        </div>
                    `;
                } catch {
                    grid.innerHTML += `
                        <div class="service-card unhealthy">
                            <div class="service-header">
                                <span class="service-name">${svc.name}</span>
                                <span class="service-status status-unhealthy">HS</span>
                            </div>
                            <div class="service-details">
                                <i class="fas fa-plug"></i> Port: ${svc.port}<br>
                                <i class="fas fa-exclamation-triangle"></i> Injoignable
                            </div>
                        </div>
                    `;
                }
            }
        }

        async function loadResources() {
            try {
                const res = await fetch(`http://localhost:${Number(basePort)+1}/api/resources/available`);
                const resources = await res.json();
                // Compter par type
                const typeCount = {};
                resources.forEach(r => typeCount[r.type] = (typeCount[r.type] || 0) + 1);
                const types = Object.keys(typeCount);
                const counts = Object.values(typeCount);

                // Mettre à jour ou créer le graphique
                if (resourcesChart) resourcesChart.destroy();
                const ctx = document.getElementById('resourcesChart').getContext('2d');
                resourcesChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: types,
                        datasets: [{
                            data: counts,
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                        }]
                    }
                });

                // Afficher des stats
                const total = resources.length;
                const available = resources.filter(r => r.isAvailable).length;
                // On peut ajouter un petit résumé dans le service ResourceAgent (optionnel)
            } catch (e) {
                console.log("Erreur chargement ressources", e);
            }
        }

        async function loadAlerts() {
            try {
                const res = await fetch(`http://localhost:${Number(basePort)+3}/api/alerts`);
                const alerts = await res.json();
                const tbody = document.querySelector('#alertsTable tbody');
                if (alerts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">Aucune alerte</td></tr>';
                } else {
                    tbody.innerHTML = alerts.slice(0, 5).map(a => `
                        <tr>
                            <td>${new Date(a.timestamp).toLocaleTimeString()}</td>
                            <td>${a.area}</td>
                            <td><span class="badge badge-${a.severity === 'haute' ? 'high' : (a.severity === 'moyenne' ? 'medium' : 'low')}">${a.severity}</span></td>
                            <td>${a.receivedAt ? 'Reçue' : 'Nouvelle'}</td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.log("Erreur chargement alertes", e);
            }
        }

        async function loadPerformance() {
            // Simuler des données de performance à partir des rapports existants
            // On pourrait charger le dernier fichier JSON d'analyse
            try {
                const response = await fetch('/last-analysis.json'); // à implémenter côté serveur si nécessaire
                // Sinon on génère des données fictives
                const labels = ['00:00', '00:05', '00:10', '00:15', '00:20', '00:25'];
                const data = [120, 135, 110, 190, 170, 145];

                if (performanceChart) performanceChart.destroy();
                const ctx = document.getElementById('performanceChart').getContext('2d');
                performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Temps de réponse (ms)',
                            data: data,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } catch (e) {
                console.log("Erreur chargement performance", e);
            }
        }

        function refreshAll() {
            checkHealth();
            loadResources();
            loadAlerts();
            loadPerformance();
            document.getElementById('lastRefresh').innerText = new Date().toLocaleTimeString();
        }

        // Rafraîchissement toutes les 10 secondes
        setInterval(refreshAll, 10000);
        window.onload = refreshAll;
    </script>
</body>
</html>
